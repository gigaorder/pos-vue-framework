<script>
  import _ from 'lodash'
  import { generateGridCSS, parseLayoutJson } from './logic/GGridGeneratorUtil'
  import { onMounted, onUpdated } from '@vue/composition-api'

  let gridLayoutInstanceCounter = 0

  export default {
    name: 'GGridLayout',
    components: { },
    props: {
      // layout object generated by grid generator
      layout: [String, Object],

      // boolean value indicate that backgroundColor of grid generator will be applied for grid layout
      displayPreviewColor: Boolean,

      // attr name will be used to identify whether an element in slot is a target of grid layout
      identityAttr: {
        type: String,
        default: 'area'
      }
    },
    setup(props, context) {
      // vue template ref id
      const refIdWrapperElement = 'el'

      // a unique uid for scoped stylesheet of grid layout instance
      const uid = 'data-g-grid-layout-' + (gridLayoutInstanceCounter++)

      const addAreaClassForPredefinedArea = () => {
        // assign class for pre-defined area
        const defaultSlot = context.refs[refIdWrapperElement]
        const areaNodes = defaultSlot.querySelectorAll(`[${props.identityAttr}]`)
        _.each(areaNodes, node => node.classList.add(node.getAttribute(props.identityAttr)))
      }

      onMounted(() => addAreaClassForPredefinedArea())
      onUpdated(() => addAreaClassForPredefinedArea())

      // try to find pre-defined VNode in default slot of gridLayout
      function _findVnodeInSlot(name) {
        return _.find(context.slots.default(), slot => {
          return slot && slot.data && slot.data.attrs && slot.data.attrs[props.identityAttr] === name
        })
      }

      function processLayout(model) {
        // find a pre-defined Vnode in default slot, if default slot doesn't include current name
        // then add new div wrapper
        let vNode = _findVnodeInSlot(model.name)
        if (!vNode) {
          // assign model class to vnode
          const attrs = { class: model.name }
          let refWrapper = null
          let styleEl = null
          // assign stuff if model is root node
          if (!model.parent) {
            attrs[uid] = ''
            refWrapper = { ref : refIdWrapperElement }
            styleEl = <style type="text/css">
              {generateGridCSS(props.layout, uid, { showBackgroundColor: props.displayPreviewColor })}
            </style>
          }
          vNode = <div {...{ attrs }} {...refWrapper}>
            {styleEl}
            {_.map(model.subAreas, processLayout)}
          </div>
        }

        return vNode
      }

      const layout = (typeof(props.layout) === 'string') ? parseLayoutJson(props.layout) : props.layout

      return function() {
        return processLayout(layout)
      }
    }
  }
</script>
